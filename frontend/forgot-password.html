<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wachtwoord Vergeten - TenderZen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 420px;
            padding: 48px 40px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            text-align: center;
            margin-bottom: 16px;
            display: flex;
            justify-content: center;
        }

        .logo-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }

        .title {
            text-align: center;
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .subtitle {
            text-align: center;
            color: #64748b;
            font-size: 15px;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="email"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
            font-family: inherit;
        }

        input[type="email"]:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .back-link {
            text-align: center;
            margin-top: 24px;
        }

        .back-link a {
            color: #8b5cf6;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .message.error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }

        .message.success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
        }

        .message.show {
            display: flex;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .success-container {
            display: none;
            text-align: center;
        }

        .success-container.show {
            display: block;
        }

        .form-container.hide {
            display: none;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>

    <!-- Load Supabase library - UMD bundle -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <!-- Load TenderZen Icons Library -->
    <script src="js/icons.js"></script>
    
    <!-- Load Config (als module voor globale variabelen) -->
    <script src="js/config.js" type="module"></script>
</head>

<body>
    <div class="container">
        <!-- Form View -->
        <div id="form-container" class="form-container">
            <div class="logo">
                <div class="logo-icon" id="logo-icon">
                    <!-- Icon wordt via JS ingeladen -->
                </div>
            </div>
            <h1 class="title">Wachtwoord vergeten?</h1>
            <p class="subtitle">
                Geen probleem! Vul je email in en we sturen je een link om je wachtwoord te resetten.
            </p>

            <!-- Messages -->
            <div id="error-message" class="message error">
                <span id="error-message-icon"></span>
                <span id="error-message-text"></span>
            </div>

            <!-- Form -->
            <form id="forgot-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" placeholder="jouw@email.nl" required
                        autocomplete="email">
                </div>

                <button type="submit" class="submit-btn" id="submit-btn">
                    <span id="submit-btn-icon"></span>
                    <span id="submit-btn-text">Verstuur reset link</span>
                </button>
            </form>

            <div class="back-link">
                <a href="login.html" id="back-link">
                    <span id="back-link-icon"></span>
                    Terug naar inloggen
                </a>
            </div>
        </div>

        <!-- Success View -->
        <div id="success-container" class="success-container">
            <div class="success-icon" id="success-icon">
                <!-- Icon wordt via JS ingeladen -->
            </div>
            <h1 class="title">Email verstuurd!</h1>
            <p class="subtitle">
                We hebben een email gestuurd naar <strong id="sent-email"></strong> met een link om je wachtwoord te
                resetten.
                <br><br>
                Controleer ook je spam folder als je de email niet ziet.
            </p>

            <div class="back-link">
                <a href="login.html" id="success-back-link">
                    <span id="success-back-link-icon"></span>
                    Terug naar inloggen
                </a>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // WACHT TOT CONFIG GELADEN IS
        // ========================================
        function waitForConfig(callback, maxAttempts = 50) {
            let attempts = 0;
            const check = () => {
                if (window.SUPABASE_URL && window.SUPABASE_PUBLISHABLE_KEY) {
                    callback();
                } else if (attempts < maxAttempts) {
                    attempts++;
                    setTimeout(check, 100);
                } else {
                    console.error('‚ùå Config kon niet worden geladen na', maxAttempts, 'pogingen');
                }
            };
            check();
        }

        // ========================================
        // DOM ELEMENTS
        // ========================================
        const form = document.getElementById('forgot-form');
        const submitBtn = document.getElementById('submit-btn');
        const submitBtnIcon = document.getElementById('submit-btn-icon');
        const submitBtnText = document.getElementById('submit-btn-text');
        const errorMessage = document.getElementById('error-message');
        const errorMessageIcon = document.getElementById('error-message-icon');
        const errorMessageText = document.getElementById('error-message-text');
        const emailInput = document.getElementById('email');
        const formContainer = document.getElementById('form-container');
        const successContainer = document.getElementById('success-container');
        const sentEmail = document.getElementById('sent-email');

        // Pre-fill email from URL query parameter if provided
        const urlParams = new URLSearchParams(window.location.search);
        const emailParam = urlParams.get('email');
        if (emailParam) {
            emailInput.value = emailParam;
        }

        // ========================================
        // ICON INITIALIZATION
        // ========================================
        let iconRetries = 0;
        const MAX_ICON_RETRIES = 20;

        function initializeIcons() {
            if (!window.Icons || !window.IconColors) {
                if (iconRetries < MAX_ICON_RETRIES) {
                    iconRetries++;
                    setTimeout(initializeIcons, 150);
                }
                return;
            }
            iconRetries = 0;

            // Logo icon (lock)
            const logoIcon = document.getElementById('logo-icon');
            if (logoIcon) {
                logoIcon.innerHTML = Icons.lock({ size: 32, color: IconColors.purple });
            }

            // Submit button icon
            if (submitBtnIcon) {
                submitBtnIcon.innerHTML = Icons.mail({ size: 18, color: IconColors.white });
            }

            // Back link icon
            const backLinkIcon = document.getElementById('back-link-icon');
            if (backLinkIcon) {
                backLinkIcon.innerHTML = Icons.chevronLeft({ size: 16, color: IconColors.purple });
            }

            // Error message icon
            if (errorMessageIcon) {
                errorMessageIcon.innerHTML = Icons.alertCircle({ size: 18, color: IconColors.red });
            }

            // Success view icons
            const successIcon = document.getElementById('success-icon');
            if (successIcon) {
                successIcon.innerHTML = Icons.checkCircle({ size: 40, color: IconColors.green });
            }

            const successBackLinkIcon = document.getElementById('success-back-link-icon');
            if (successBackLinkIcon) {
                successBackLinkIcon.innerHTML = Icons.chevronLeft({ size: 16, color: IconColors.purple });
            }

            console.log('‚úÖ Icons ge√Ønitialiseerd');
        }

        // Initialize icons when page loads
        initializeIcons();

        // ========================================
        // DUTCH VALIDATION MESSAGES
        // ========================================
        emailInput.addEventListener('invalid', (e) => {
            if (emailInput.validity.valueMissing) {
                emailInput.setCustomValidity('Vul je emailadres in.');
            } else if (emailInput.validity.typeMismatch) {
                emailInput.setCustomValidity('Vul een geldig emailadres in.');
            } else {
                emailInput.setCustomValidity('');
            }
        });

        emailInput.addEventListener('input', () => {
            emailInput.setCustomValidity('');
        });

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function showError(message) {
            errorMessageText.textContent = message;
            errorMessage.classList.add('show');
        }

        function hideError() {
            errorMessage.classList.remove('show');
        }

        function setLoading(isLoading) {
            submitBtn.disabled = isLoading;

            if (isLoading) {
                submitBtnIcon.innerHTML = '<span class="loading-spinner"></span>';
                submitBtnText.textContent = 'Versturen...';
            } else {
                if (window.Icons) {
                    submitBtnIcon.innerHTML = Icons.mail({ size: 18, color: IconColors.white });
                }
                submitBtnText.textContent = 'Verstuur reset link';
            }
        }

        function showSuccess(email) {
            formContainer.classList.add('hide');
            sentEmail.textContent = email;
            successContainer.classList.add('show');
        }

        // ========================================
        // MAIN APP - WACHT OP CONFIG
        // ========================================
        waitForConfig(() => {
            console.log('‚úÖ Config geladen, Supabase initialiseren...');

            // ========================================
            // SUPABASE CONFIGURATIE
            // ========================================
            let supabaseClient;
            
            // Check of client al bestaat (van config.js)
            if (window.supabaseClient && window.supabaseClient.auth) {
                supabaseClient = window.supabaseClient;
                console.log('‚úÖ Using existing Supabase client');
            } 
            // Anders maak nieuwe client van library
            else if (window.supabase && window.supabase.createClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);
                window.supabaseClient = supabaseClient;
                console.log('‚úÖ Supabase client created from library');
            }
            else {
                console.error('‚ùå Supabase library not available');
                showError('Supabase kon niet worden geladen. Ververs de pagina.');
                return;
            }

            // ========================================
            // FORM SUBMIT
            // ========================================
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideError();
                setLoading(true);

                const email = emailInput.value.trim();

                console.log('üìß Sending password reset to:', email);

                if (!supabaseClient) {
                    showError('Supabase is niet ge√Ønitialiseerd. Ververs de pagina.');
                    setLoading(false);
                    return;
                }

                try {
                    const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin + '/reset-password.html'
                    });

                    if (error) throw error;

                    console.log('‚úÖ Password reset email sent');
                    showSuccess(email);

                } catch (error) {
                    console.error('‚ùå Error:', error);

                    let errorMsg = 'Er is een fout opgetreden.';

                    if (error.message.includes('rate limit')) {
                        errorMsg = 'Te veel verzoeken. Probeer het later opnieuw.';
                    } else if (error.message) {
                        errorMsg = error.message;
                    }

                    showError(errorMsg);
                    setLoading(false);
                }
            });

            console.log('üîê Forgot password page loaded');
        });
    </script>
</body>

</html>