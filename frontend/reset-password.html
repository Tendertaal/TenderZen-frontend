<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nieuw Wachtwoord - TenderZen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 420px;
            padding: 48px 40px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            text-align: center;
            margin-bottom: 16px;
            display: flex;
            justify-content: center;
        }

        .logo-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }

        .title {
            text-align: center;
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .subtitle {
            text-align: center;
            color: #64748b;
            font-size: 15px;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .password-input-wrapper {
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
        }

        input[type="password"],
        input[type="text"].password-field,
        input[type="text"].totp-field {
            width: 100%;
            padding: 14px 45px 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
            font-family: inherit;
        }

        input[type="text"].totp-field {
            padding: 14px 16px;
            text-align: center;
            font-size: 24px;
            letter-spacing: 8px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
        }

        input[type="password"]:focus,
        input[type="text"].password-field:focus,
        input[type="text"].totp-field:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
        }

        input:disabled {
            background: #f8fafc;
            cursor: not-allowed;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
            z-index: 10;
        }

        .password-toggle:hover {
            color: #8b5cf6;
        }

        .password-toggle:focus {
            outline: none;
            color: #8b5cf6;
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .message.error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }

        .message.success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
        }

        .message.info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #2563eb;
        }

        .message.show {
            display: flex;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .password-requirements {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
            padding-left: 8px;
        }

        .password-requirements li {
            margin: 4px 0;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .requirement-met {
            color: #16a34a;
        }

        .requirement-not-met {
            color: #dc2626;
        }

        .success-container {
            display: none;
            text-align: center;
        }

        .success-container.show {
            display: block;
        }

        .form-container.hide {
            display: none;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 32px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            margin-top: 24px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .error-container {
            display: none;
            text-align: center;
        }

        .error-container.show {
            display: block;
        }

        .error-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Loading state */
        .loading-container {
            display: none;
            text-align: center;
            padding: 40px 0;
        }

        .loading-container.show {
            display: block;
        }

        .loading-container .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e2e8f0;
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        .back-link {
            text-align: center;
            margin-top: 24px;
        }

        .back-link a {
            color: #8b5cf6;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        /* MFA Container Styles */
        .mfa-container {
            display: none;
            text-align: center;
        }

        .mfa-container.show {
            display: block;
        }

        .mfa-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .totp-hint {
            font-size: 13px;
            color: #64748b;
            margin-top: 8px;
        }

        .mfa-form {
            margin-top: 24px;
        }
    </style>

    <!-- Load Supabase UMD bundle -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <!-- Load TenderZen Icons Library -->
    <script src="js/icons.js"></script>
</head>

<body>
    <div class="container">
        <!-- Loading View (shown while processing token) -->
        <div id="loading-container" class="loading-container show">
            <div class="spinner"></div>
            <h2 class="title">Even geduld...</h2>
            <p class="subtitle">Je reset link wordt geverifieerd.</p>
        </div>

        <!-- MFA Verification View -->
        <div id="mfa-container" class="mfa-container">
            <div class="mfa-icon" id="mfa-icon">
                <!-- Icon wordt via JS ingeladen -->
            </div>
            <h1 class="title">Verificatie vereist</h1>
            <p class="subtitle">
                Voer de 6-cijferige code in van je authenticator app om door te gaan.
            </p>

            <!-- MFA Error Message -->
            <div id="mfa-error-message" class="message error">
                <span id="mfa-error-message-icon"></span>
                <span id="mfa-error-message-text"></span>
            </div>

            <!-- MFA Form -->
            <form id="mfa-form" class="mfa-form">
                <div class="form-group">
                    <label for="totp-code">Authenticatie Code</label>
                    <input type="text" id="totp-code" class="totp-field" placeholder="000000" maxlength="6"
                        autocomplete="off" required>
                    <p class="totp-hint">Voer de 6-cijferige code in van je authenticator app</p>
                </div>
                <button type="submit" id="mfa-submit-btn" class="submit-btn">
                    <span id="mfa-submit-btn-icon"></span>
                    <span id="mfa-submit-btn-text">Verifi√´ren</span>
                </button>
                <div class="back-link">
                    <a href="#" onclick="location.reload();"><span id="mfa-back-link-icon"></span> Terug</a>
                </div>
            </form>
        </div>

        <!-- Password Reset Form View -->
        <div id="form-container" class="form-container hide">
            <div class="logo">
                <div class="logo-icon" id="logo-icon"></div>
            </div>
            <h1 class="title">Nieuw Wachtwoord</h1>
            <p class="subtitle">Kies een sterk wachtwoord voor je account.</p>

            <!-- Error Message -->
            <div id="error-message" class="message error">
                <span id="error-message-icon"></span>
                <span id="error-message-text"></span>
            </div>

            <!-- Info Message -->
            <div id="info-message" class="message info">
                <span id="info-message-icon"></span>
                <span id="info-message-text"></span>
            </div>

            <!-- Password Reset Form -->
            <form id="reset-form">
                <!-- Password Field -->
                <div class="form-group">
                    <label for="password">Nieuw Wachtwoord</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="password" class="password-field" placeholder="Voer je wachtwoord in"
                            required>
                        <button type="button" id="toggle-password" class="password-toggle"></button>
                    </div>
                </div>

                <!-- Password Requirements -->
                <ul class="password-requirements">
                    <li id="req-length" class="requirement-not-met">
                        <span class="req-icon"></span>
                        <span>Minimaal 8 karakters</span>
                    </li>
                    <li id="req-uppercase" class="requirement-not-met">
                        <span class="req-icon"></span>
                        <span>Minimaal 1 hoofdletter</span>
                    </li>
                    <li id="req-number" class="requirement-not-met">
                        <span class="req-icon"></span>
                        <span>Minimaal 1 cijfer</span>
                    </li>
                    <li id="req-special" class="requirement-not-met">
                        <span class="req-icon"></span>
                        <span>Minimaal 1 speciaal teken (!@#$%^&*...)</span>
                    </li>
                </ul>

                <!-- Confirm Password Field -->
                <div class="form-group">
                    <label for="password-confirm">Bevestig Wachtwoord</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="password-confirm" class="password-field"
                            placeholder="Herhaal je wachtwoord" required>
                        <button type="button" id="toggle-password-confirm" class="password-toggle"></button>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submit-btn" class="submit-btn">
                    <span id="submit-btn-icon"></span>
                    <span id="submit-btn-text">Wachtwoord opslaan</span>
                </button>
            </form>

            <div class="back-link">
                <a href="/login.html"><span id="back-link-icon"></span> Terug naar inloggen</a>
            </div>
        </div>

        <!-- Success View -->
        <div id="success-container" class="success-container">
            <div class="success-icon" id="success-icon"></div>
            <h1 class="title">Gelukt!</h1>
            <p class="subtitle">Je wachtwoord is succesvol gewijzigd. Je bent automatisch ingelogd.</p>
            <a href="/" class="login-btn">
                <span id="login-btn-icon"></span>
                <span>Naar Dashboard</span>
            </a>
        </div>

        <!-- Error View -->
        <div id="error-container" class="error-container">
            <div class="error-icon" id="error-view-icon"></div>
            <h1 class="title">Fout</h1>
            <p class="subtitle" id="error-description">Deze reset link is ongeldig of verlopen. Vraag een nieuwe link
                aan.</p>
            <a href="forgot-password.html" class="login-btn">
                <span id="new-link-btn-icon"></span>
                <span>Nieuwe Link Aanvragen</span>
            </a>
        </div>

        <script type="module">
            // ========================================
            // SUPABASE CONFIGURATIE (centraal via config.js)
            // ========================================
            import { getSupabase } from './js/config.js';

            const supabaseClient = getSupabase();

            if (!supabaseClient) {
                console.error('‚ùå Supabase client kon niet worden ge√Ønitialiseerd');
                throw new Error('Supabase client ontbreekt');
            }

            // ========================================
            // STATE MANAGEMENT
            // ========================================
            let recoverySession = null;
            let isSessionReady = false;
            let mfaRequired = false;
            let mfaFactorId = null;

            // ========================================
            // DOM ELEMENTS
            // ========================================
            const loadingContainer = document.getElementById('loading-container');
            const formContainer = document.getElementById('form-container');
            const successContainer = document.getElementById('success-container');
            const errorContainer = document.getElementById('error-container');
            const mfaContainer = document.getElementById('mfa-container');
            const errorDescription = document.getElementById('error-description');
            const form = document.getElementById('reset-form');
            const mfaForm = document.getElementById('mfa-form');
            const submitBtn = document.getElementById('submit-btn');
            const submitBtnIcon = document.getElementById('submit-btn-icon');
            const submitBtnText = document.getElementById('submit-btn-text');
            const mfaSubmitBtn = document.getElementById('mfa-submit-btn');
            const mfaSubmitBtnIcon = document.getElementById('mfa-submit-btn-icon');
            const mfaSubmitBtnText = document.getElementById('mfa-submit-btn-text');
            const errorMessage = document.getElementById('error-message');
            const errorMessageIcon = document.getElementById('error-message-icon');
            const errorMessageText = document.getElementById('error-message-text');
            const mfaErrorMessage = document.getElementById('mfa-error-message');
            const mfaErrorMessageIcon = document.getElementById('mfa-error-message-icon');
            const mfaErrorMessageText = document.getElementById('mfa-error-message-text');
            const infoMessage = document.getElementById('info-message');
            const infoMessageIcon = document.getElementById('info-message-icon');
            const infoMessageText = document.getElementById('info-message-text');
            const passwordInput = document.getElementById('password');
            const passwordConfirmInput = document.getElementById('password-confirm');
            const totpInput = document.getElementById('totp-code');

            // ========================================
            // ICONS INITIALISEREN
            // ========================================
            function initializeIcons() {
                if (!window.Icons) {
                    console.warn('‚ö†Ô∏è Icons library niet geladen');
                    return;
                }

                console.log('‚úÖ Icons library beschikbaar, initialiseren...');

                // Initialize icons for currently visible view
                if (!loadingContainer.classList.contains('show')) {
                    if (!formContainer.classList.contains('hide')) {
                        initializeFormIcons();
                    }
                    if (successContainer.classList.contains('show')) {
                        initializeSuccessIcons();
                    }
                    if (errorContainer.classList.contains('show')) {
                        initializeErrorIcons();
                    }
                    if (mfaContainer.classList.contains('show')) {
                        initializeMfaIcons();
                    }
                }

                console.log('‚úÖ Icons ge√Ønitialiseerd');
            }

            function updateRequirementIcons() {
                if (!window.Icons) return;

                const reqLength = document.getElementById('req-length');
                const reqUppercase = document.getElementById('req-uppercase');
                const reqNumber = document.getElementById('req-number');
                const reqSpecial = document.getElementById('req-special');

                [reqLength, reqUppercase, reqNumber, reqSpecial].forEach(el => {
                    if (!el) return;
                    const iconSpan = el.querySelector('.req-icon');
                    if (!iconSpan) return;

                    if (el.classList.contains('requirement-met')) {
                        iconSpan.innerHTML = Icons.check({ size: 14, color: IconColors.green });
                    } else {
                        iconSpan.innerHTML = Icons.x({ size: 14, color: IconColors.red });
                    }
                });
            }

            // Wait for icons.js to load
            const pendingIconCallbacks = new Set();

            function waitForIcons(callback, maxAttempts = 20) {
                const callbackKey = callback.name || callback.toString().substring(0, 50);
                if (pendingIconCallbacks.has(callbackKey)) {
                    return;
                }
                pendingIconCallbacks.add(callbackKey);

                let attempts = 0;
                const check = () => {
                    if (window.Icons && window.IconColors) {
                        pendingIconCallbacks.delete(callbackKey);
                        callback();
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(check, 100);
                    } else {
                        pendingIconCallbacks.delete(callbackKey);
                        console.error('‚ùå Icons library kon niet worden geladen na', maxAttempts, 'pogingen');
                    }
                };
                check();
            }

            // ========================================
            // VIEW MANAGEMENT
            // ========================================
            function showView(viewName) {
                loadingContainer.classList.remove('show');
                formContainer.classList.add('hide');
                successContainer.classList.remove('show');
                errorContainer.classList.remove('show');
                mfaContainer.classList.remove('show');

                switch (viewName) {
                    case 'loading':
                        loadingContainer.classList.add('show');
                        break;
                    case 'mfa':
                        mfaContainer.classList.add('show');
                        initializeMfaIcons();
                        totpInput.focus();
                        break;
                    case 'form':
                        formContainer.classList.remove('hide');
                        initializeFormIcons();
                        passwordInput.focus();
                        break;
                    case 'success':
                        successContainer.classList.add('show');
                        initializeSuccessIcons();
                        break;
                    case 'error':
                        errorContainer.classList.add('show');
                        initializeErrorIcons();
                        break;
                }
            }

            function showErrorView(message) {
                errorDescription.textContent = message || 'Deze reset link is ongeldig of verlopen. Vraag een nieuwe link aan.';
                showView('error');
            }

            // ========================================
            // VIEW-SPECIFIC ICON INITIALIZATION
            // ========================================
            let formIconRetries = 0;
            let successIconRetries = 0;
            let errorIconRetries = 0;
            let mfaIconRetries = 0;
            const MAX_ICON_RETRIES = 20;

            function initializeFormIcons() {
                if (!window.Icons || !window.IconColors) {
                    if (formIconRetries < MAX_ICON_RETRIES) {
                        formIconRetries++;
                        setTimeout(initializeFormIcons, 150);
                    }
                    return;
                }
                formIconRetries = 0;

                // Logo icon (key)
                const logoIcon = document.getElementById('logo-icon');
                if (logoIcon) {
                    logoIcon.innerHTML = Icons.key({ size: 32, color: IconColors.purple });
                }

                // Password toggle icons
                const togglePassword = document.getElementById('toggle-password');
                const togglePasswordConfirm = document.getElementById('toggle-password-confirm');

                if (togglePassword) {
                    togglePassword.innerHTML = Icons.eyeOff({ size: 20, color: IconColors.slate });
                }
                if (togglePasswordConfirm) {
                    togglePasswordConfirm.innerHTML = Icons.eyeOff({ size: 20, color: IconColors.slate });
                }

                // Submit button icon
                if (submitBtnIcon) {
                    submitBtnIcon.innerHTML = Icons.save({ size: 18, color: IconColors.white });
                }

                // Back link icon
                const backLinkIcon = document.getElementById('back-link-icon');
                if (backLinkIcon) {
                    backLinkIcon.innerHTML = Icons.chevronLeft({ size: 16, color: IconColors.purple });
                }

                // Message icons
                if (errorMessageIcon) {
                    errorMessageIcon.innerHTML = Icons.alertCircle({ size: 18, color: IconColors.red });
                }
                if (infoMessageIcon) {
                    infoMessageIcon.innerHTML = Icons.info({ size: 18, color: IconColors.blue });
                }

                // Requirement icons
                updateRequirementIcons();

                console.log('‚úÖ Form icons ge√Ønitialiseerd');
            }

            function initializeSuccessIcons() {
                if (!window.Icons || !window.IconColors) {
                    if (successIconRetries < MAX_ICON_RETRIES) {
                        successIconRetries++;
                        setTimeout(initializeSuccessIcons, 150);
                    }
                    return;
                }
                successIconRetries = 0;

                const successIcon = document.getElementById('success-icon');
                if (successIcon) {
                    successIcon.innerHTML = Icons.checkCircle({ size: 40, color: IconColors.green });
                }

                const loginBtnIcon = document.getElementById('login-btn-icon');
                if (loginBtnIcon) {
                    loginBtnIcon.innerHTML = Icons.logOut({ size: 18, color: IconColors.white });
                }

                console.log('‚úÖ Success icons ge√Ønitialiseerd');
            }

            function initializeErrorIcons() {
                if (!window.Icons || !window.IconColors) {
                    if (errorIconRetries < MAX_ICON_RETRIES) {
                        errorIconRetries++;
                        setTimeout(initializeErrorIcons, 150);
                    }
                    return;
                }
                errorIconRetries = 0;

                const errorViewIcon = document.getElementById('error-view-icon');
                if (errorViewIcon) {
                    errorViewIcon.innerHTML = Icons.xCircle({ size: 40, color: IconColors.red });
                }

                const newLinkBtnIcon = document.getElementById('new-link-btn-icon');
                if (newLinkBtnIcon) {
                    newLinkBtnIcon.innerHTML = Icons.mail({ size: 18, color: IconColors.white });
                }

                console.log('‚úÖ Error icons ge√Ønitialiseerd');
            }

            function initializeMfaIcons() {
                if (!window.Icons || !window.IconColors) {
                    if (mfaIconRetries < MAX_ICON_RETRIES) {
                        mfaIconRetries++;
                        setTimeout(initializeMfaIcons, 150);
                    }
                    return;
                }
                mfaIconRetries = 0;

                const mfaIcon = document.getElementById('mfa-icon');
                if (mfaIcon) {
                    mfaIcon.innerHTML = Icons.shield({ size: 40, color: IconColors.purple });
                }

                if (mfaSubmitBtnIcon) {
                    mfaSubmitBtnIcon.innerHTML = Icons.check({ size: 18, color: IconColors.white });
                }

                if (mfaErrorMessageIcon) {
                    mfaErrorMessageIcon.innerHTML = Icons.alertCircle({ size: 18, color: IconColors.red });
                }

                const mfaBackLinkIcon = document.getElementById('mfa-back-link-icon');
                if (mfaBackLinkIcon) {
                    mfaBackLinkIcon.innerHTML = Icons.chevronLeft({ size: 16, color: IconColors.purple });
                }

                console.log('‚úÖ MFA icons ge√Ønitialiseerd');
            }

            // ========================================
            // MFA FUNCTIONS
            // ========================================
            async function checkMfaRequired() {
                console.log('üîê Checking if MFA is required...');

                try {
                    // Get the current session's AAL (Authenticator Assurance Level)
                    const { data: { currentLevel, nextLevel }, error: aalError } = await supabaseClient.auth.mfa.getAuthenticatorAssuranceLevel();

                    if (aalError) {
                        console.error('‚ùå Error checking AAL:', aalError);
                        return false;
                    }

                    console.log('üîç Current AAL:', currentLevel, '| Next AAL:', nextLevel);

                    // If nextLevel is aal2 but currentLevel is aal1, MFA verification is required
                    if (nextLevel === 'aal2' && currentLevel === 'aal1') {
                        console.log('üîê MFA verification required (AAL1 ‚Üí AAL2)');

                        // Get the TOTP factor
                        const { data: { totp }, error: factorError } = await supabaseClient.auth.mfa.listFactors();

                        if (factorError) {
                            console.error('‚ùå Error listing MFA factors:', factorError);
                            return false;
                        }

                        if (totp && totp.length > 0) {
                            mfaFactorId = totp[0].id;
                            console.log('‚úÖ TOTP factor found:', mfaFactorId);
                            return true;
                        } else {
                            console.log('‚ö†Ô∏è No TOTP factors found');
                            return false;
                        }
                    }

                    console.log('‚úÖ No MFA verification required');
                    return false;

                } catch (err) {
                    console.error('‚ùå MFA check failed:', err);
                    return false;
                }
            }

            async function verifyMfa(totpCode) {
                console.log('üîê Verifying MFA code...');

                if (!mfaFactorId) {
                    throw new Error('Geen MFA factor gevonden');
                }

                try {
                    // Create a challenge
                    const { data: challengeData, error: challengeError } = await supabaseClient.auth.mfa.challenge({
                        factorId: mfaFactorId
                    });

                    if (challengeError) {
                        console.error('‚ùå MFA challenge error:', challengeError);
                        throw challengeError;
                    }

                    console.log('‚úÖ MFA challenge created:', challengeData.id);

                    // Verify the challenge with the TOTP code
                    const { data: verifyData, error: verifyError } = await supabaseClient.auth.mfa.verify({
                        factorId: mfaFactorId,
                        challengeId: challengeData.id,
                        code: totpCode
                    });

                    if (verifyError) {
                        console.error('‚ùå MFA verify error:', verifyError);
                        throw verifyError;
                    }

                    console.log('‚úÖ MFA verified successfully');

                    // Update recovery session with the new session data
                    if (verifyData.session) {
                        recoverySession = verifyData.session;
                    }

                    return true;

                } catch (err) {
                    throw err;
                }
            }

            // ========================================
            // SESSION INITIALIZATION
            // ========================================
            async function initializeSession() {
                console.log('üîê Initializing password reset session...');

                const urlHash = window.location.hash;
                const hasRecoveryToken = urlHash && (urlHash.includes('access_token') || urlHash.includes('type=recovery'));

                console.log('üîç URL Hash:', urlHash ? 'Present' : 'Empty');
                console.log('üîç Has recovery token:', hasRecoveryToken);

                if (!hasRecoveryToken) {
                    // No token in URL - check if we have an existing session
                    const { data: { session } } = await supabaseClient.auth.getSession();

                    if (session) {
                        console.log('‚úÖ Existing session found');
                        recoverySession = session;
                        isSessionReady = true;

                        // Check if MFA is required
                        mfaRequired = await checkMfaRequired();
                        if (mfaRequired) {
                            showView('mfa');
                        } else {
                            showView('form');
                        }
                    } else {
                        console.log('‚ùå No token and no session');
                        showErrorView('Geen reset token gevonden. Open de link uit je email opnieuw.');
                    }
                    return;
                }

                // We have a recovery token - wait for Supabase to process it
                console.log('‚è≥ Waiting for Supabase to process recovery token...');

                // Set a timeout for token processing
                const timeout = setTimeout(() => {
                    if (!isSessionReady) {
                        console.log('‚ùå Timeout waiting for session');
                        showErrorView('De reset link kon niet worden geverifieerd. Probeer de link opnieuw te openen of vraag een nieuwe aan.');
                    }
                }, 10000); // 10 second timeout

                // Listen for auth state changes
                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    console.log('üîê Auth event:', event, session ? `(user: ${session.user?.email})` : '(no session)');

                    if (event === 'PASSWORD_RECOVERY') {
                        console.log('‚úÖ PASSWORD_RECOVERY event received');
                        clearTimeout(timeout);

                        if (session) {
                            recoverySession = session;
                            isSessionReady = true;

                            // Check if MFA is required
                            mfaRequired = await checkMfaRequired();
                            if (mfaRequired) {
                                showView('mfa');
                            } else {
                                showView('form');
                            }
                        } else {
                            console.log('‚è≥ Waiting for session in SIGNED_IN event...');
                        }
                    } else if (event === 'SIGNED_IN' && session && !isSessionReady) {
                        console.log('‚úÖ SIGNED_IN event with session');
                        clearTimeout(timeout);
                        recoverySession = session;
                        isSessionReady = true;

                        // Check if MFA is required
                        mfaRequired = await checkMfaRequired();
                        if (mfaRequired) {
                            showView('mfa');
                        } else {
                            showView('form');
                        }
                    } else if (event === 'TOKEN_REFRESHED' && session) {
                        console.log('üîÑ Token refreshed');
                        recoverySession = session;
                    }
                });

                // Also try to manually extract and set session from URL
                setTimeout(async () => {
                    if (isSessionReady) return;

                    console.log('üîß Attempting manual token extraction...');

                    try {
                        // Parse hash parameters
                        const hashParams = new URLSearchParams(urlHash.substring(1));
                        const accessToken = hashParams.get('access_token');
                        const refreshToken = hashParams.get('refresh_token');
                        const type = hashParams.get('type');

                        console.log('üîç Token type:', type);
                        console.log('üîç Access token:', accessToken ? 'Present' : 'Missing');
                        console.log('üîç Refresh token:', refreshToken ? 'Present' : 'Missing');

                        if (accessToken && refreshToken) {
                            console.log('üîß Setting session manually...');

                            const { data, error } = await supabaseClient.auth.setSession({
                                access_token: accessToken,
                                refresh_token: refreshToken
                            });

                            if (error) {
                                console.error('‚ùå Error setting session:', error.message);

                                if (error.message.includes('expired') || error.message.includes('invalid')) {
                                    showErrorView('Deze reset link is verlopen. Vraag een nieuwe link aan.');
                                } else {
                                    showErrorView(`Fout bij verifi√´ren: ${error.message}`);
                                }
                                clearTimeout(timeout);
                                return;
                            }

                            if (data.session) {
                                console.log('‚úÖ Session set manually');
                                recoverySession = data.session;
                                isSessionReady = true;
                                clearTimeout(timeout);

                                // Check if MFA is required
                                mfaRequired = await checkMfaRequired();
                                if (mfaRequired) {
                                    showView('mfa');
                                } else {
                                    showView('form');
                                }
                            }
                        }
                    } catch (err) {
                        console.error('‚ùå Manual extraction failed:', err);
                    }
                }, 1500);
            }

            // ========================================
            // PASSWORD VALIDATION
            // ========================================
            function validatePassword(password) {
                const requirements = {
                    length: password.length >= 8,
                    uppercase: /[A-Z]/.test(password),
                    number: /[0-9]/.test(password),
                    special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?`~]/.test(password)
                };

                const reqLength = document.getElementById('req-length');
                const reqUppercase = document.getElementById('req-uppercase');
                const reqNumber = document.getElementById('req-number');
                const reqSpecial = document.getElementById('req-special');

                reqLength.className = requirements.length ? 'requirement-met' : 'requirement-not-met';
                reqUppercase.className = requirements.uppercase ? 'requirement-met' : 'requirement-not-met';
                reqNumber.className = requirements.number ? 'requirement-met' : 'requirement-not-met';
                reqSpecial.className = requirements.special ? 'requirement-met' : 'requirement-not-met';

                // Update icons
                updateRequirementIcons();

                return requirements.length && requirements.uppercase && requirements.number && requirements.special;
            }

            passwordInput.addEventListener('input', (e) => {
                validatePassword(e.target.value);
            });

            // ========================================
            // PASSWORD TOGGLE
            // ========================================
            function setupPasswordToggle(inputId, toggleId) {
                const input = document.getElementById(inputId);
                const toggle = document.getElementById(toggleId);

                if (input && toggle) {
                    toggle.addEventListener('click', (e) => {
                        e.preventDefault();
                        const isPassword = input.type === 'password';
                        input.type = isPassword ? 'text' : 'password';

                        if (window.Icons) {
                            if (isPassword) {
                                toggle.innerHTML = Icons.eye({ size: 20, color: IconColors.blue });
                            } else {
                                toggle.innerHTML = Icons.eyeOff({ size: 20, color: IconColors.slate });
                            }
                        }
                    });
                }
            }

            // ========================================
            // UTILITY FUNCTIONS
            // ========================================
            function showError(message) {
                errorMessageText.textContent = message;
                errorMessage.classList.add('show');
                infoMessage.classList.remove('show');
            }

            function showMfaError(message) {
                mfaErrorMessageText.textContent = message;
                mfaErrorMessage.classList.add('show');
            }

            function hideMfaError() {
                mfaErrorMessage.classList.remove('show');
            }

            function showInfo(message) {
                infoMessageText.textContent = message;
                infoMessage.classList.add('show');
                errorMessage.classList.remove('show');
            }

            function hideMessages() {
                errorMessage.classList.remove('show');
                infoMessage.classList.remove('show');
            }

            function setLoading(isLoading) {
                submitBtn.disabled = isLoading;

                if (isLoading) {
                    submitBtnIcon.innerHTML = '<span class="loading-spinner"></span>';
                    submitBtnText.textContent = 'Opslaan...';
                } else {
                    if (window.Icons) {
                        submitBtnIcon.innerHTML = Icons.save({ size: 18, color: IconColors.white });
                    }
                    submitBtnText.textContent = 'Wachtwoord opslaan';
                }
            }

            function setMfaLoading(isLoading) {
                mfaSubmitBtn.disabled = isLoading;
                totpInput.disabled = isLoading;

                if (isLoading) {
                    mfaSubmitBtnIcon.innerHTML = '<span class="loading-spinner"></span>';
                    mfaSubmitBtnText.textContent = 'Verifi√´ren...';
                } else {
                    if (window.Icons) {
                        mfaSubmitBtnIcon.innerHTML = Icons.check({ size: 18, color: IconColors.white });
                    }
                    mfaSubmitBtnText.textContent = 'Verifi√´ren';
                }
            }

            // ========================================
            // MFA FORM SUBMIT
            // ========================================
            mfaForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMfaError();

                const totpCode = totpInput.value.trim();

                if (totpCode.length !== 6 || !/^\d{6}$/.test(totpCode)) {
                    showMfaError('Voer een geldige 6-cijferige code in.');
                    return;
                }

                setMfaLoading(true);
                console.log('üîê Submitting MFA code...');

                try {
                    await verifyMfa(totpCode);

                    // MFA verified, now show the password form
                    mfaRequired = false;
                    showView('form');

                } catch (error) {
                    console.error('‚ùå MFA Error:', error);

                    let errorMsg = 'Verificatie mislukt.';

                    if (error.message.includes('Invalid') || error.message.includes('invalid')) {
                        errorMsg = 'Ongeldige code. Probeer opnieuw.';
                    } else if (error.message.includes('expired')) {
                        errorMsg = 'Code verlopen. Vraag een nieuwe aan in je authenticator app.';
                    } else if (error.message) {
                        errorMsg = error.message;
                    }

                    showMfaError(errorMsg);
                    totpInput.value = '';
                    totpInput.focus();
                    setMfaLoading(false);
                }
            });

            // Auto-submit when 6 digits are entered
            totpInput.addEventListener('input', (e) => {
                // Only allow digits
                e.target.value = e.target.value.replace(/\D/g, '');

                // Auto-submit when 6 digits entered
                if (e.target.value.length === 6) {
                    mfaForm.dispatchEvent(new Event('submit'));
                }
            });

            // ========================================
            // PASSWORD HISTORY CHECK (PYTHON BACKEND)
            // ========================================
            // Flow:
            // 1. Roep Python API aan met nieuw wachtwoord
            // 2. Backend checkt: nieuw != huidig, nieuw niet in history
            // 3. Als OK: Backend slaat HUIDIG wachtwoord op in history
            // 4. Frontend wijzigt wachtwoord naar nieuw
            // 
            // BELANGRIJK: Alleen OUDE wachtwoorden komen in history,
            // nooit het huidige/nieuwe wachtwoord!
            // ========================================

            // Pas deze URL aan naar je backend URL
            // Gebruik centrale API-configuratie
            const PASSWORD_API_URL = `${window.API_CONFIG?.baseURL || 'http://localhost:8000'}/api/v1/password/validate`;
            // Voor productie:
            // const PASSWORD_API_URL = 'https://jouw-backend.com/api/v1/password/validate';

            async function validateAndPreparePasswordChange(newPassword, accessToken) {
                console.log('üîç Validating password and preparing change...');

                try {
                    const response = await fetch(PASSWORD_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({
                            new_password: newPassword  // snake_case voor Python
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        console.error('‚ùå Password validation failed:', data.detail || data.error);
                        // If the API fails, allow the password change
                        // (fail open - better UX, but log the error)
                        return { allowed: true };
                    }

                    console.log('üîç Password validation result:', data.allowed ? 'Allowed' : 'Not allowed');
                    return data;

                } catch (error) {
                    console.error('‚ùå Password validation error:', error);
                    // If we can't reach the API, allow the change
                    return { allowed: true };
                }
            }

            // ========================================
            // PASSWORD FORM SUBMIT
            // ========================================
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessages();

                const password = passwordInput.value;
                const passwordConfirm = passwordConfirmInput.value;

                // Validate password requirements
                if (!validatePassword(password)) {
                    showError('Wachtwoord voldoet niet aan de vereisten.');
                    return;
                }

                // Check if passwords match
                if (password !== passwordConfirm) {
                    showError('Wachtwoorden komen niet overeen.');
                    return;
                }

                // Check if session is ready
                if (!isSessionReady || !recoverySession) {
                    console.error('‚ùå No valid session available');
                    showError('Geen geldige sessie. Ververs de pagina of vraag een nieuwe reset link aan.');
                    return;
                }

                setLoading(true);
                console.log('üîë Updating password for user:', recoverySession.user?.email);

                try {
                    // Ensure we have the latest session
                    const { data: { session: currentSession } } = await supabaseClient.auth.getSession();
                    let activeSession = currentSession;

                    if (!activeSession) {
                        // Try to restore session
                        console.log('‚ö†Ô∏è Session lost, attempting to restore...');

                        const { data, error: setError } = await supabaseClient.auth.setSession({
                            access_token: recoverySession.access_token,
                            refresh_token: recoverySession.refresh_token
                        });

                        if (setError || !data.session) {
                            throw new Error('Sessie verlopen. Vraag een nieuwe reset link aan.');
                        }
                        activeSession = data.session;
                    }

                    // Validate password and prepare for change
                    // Dit doet:
                    // 1. Check of nieuw wachtwoord != huidig wachtwoord
                    // 2. Check of nieuw wachtwoord niet in history staat
                    // 3. Als OK: sla HUIDIG wachtwoord op in history (wordt "oud")
                    const validationResult = await validateAndPreparePasswordChange(password, activeSession.access_token);

                    if (!validationResult.allowed) {
                        showError(validationResult.message || 'Dit wachtwoord kan niet worden gebruikt.');
                        setLoading(false);
                        return;
                    }


                    // Update the password (HUIDIG wachtwoord is al naar history gekopieerd)
                    const { error } = await supabaseClient.auth.updateUser({
                        password: password
                    });

                    if (error) {
                        console.error('‚ùå Update password error:', error);
                        throw error;
                    }

                    console.log('‚úÖ Password updated successfully!');

                    // Automatisch inloggen met nieuwe wachtwoord
                    // Gebruik het e-mailadres uit de recoverySession
                    const email = recoverySession.user?.email;
                    if (!email) {
                        throw new Error('E-mailadres niet gevonden in sessie. Log handmatig in.');
                    }

                    // Login met nieuwe wachtwoord
                    const { error: signInError } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (signInError) {
                        console.error('‚ùå Auto-login error:', signInError);
                        showView('success'); // Toon alsnog succes, maar zonder auto-login
                        return;
                    }

                    // Redirect direct naar de app (bijv. dashboard)
                    window.location.href = '/'; // Pas eventueel aan naar je dashboard route

                } catch (error) {
                    console.error('‚ùå Error:', error);

                    let errorMsg = 'Er is een fout opgetreden.';

                    if (error.message.includes('same as') || error.message.includes('different')) {
                        errorMsg = 'Nieuw wachtwoord moet anders zijn dan het huidige.';
                    } else if (error.message.includes('expired') || error.message.includes('invalid')) {
                        errorMsg = 'Je sessie is verlopen. Vraag een nieuwe reset link aan.';
                    } else if (error.message.includes('AAL2') || error.message.includes('MFA')) {
                        errorMsg = 'MFA verificatie vereist. Ververs de pagina en probeer opnieuw.';
                        // Redirect back to MFA view
                        setTimeout(() => {
                            mfaRequired = true;
                            showView('mfa');
                        }, 2000);
                    } else if (error.message) {
                        errorMsg = error.message;
                    }

                    showError(errorMsg);
                    setLoading(false);
                }
            });

            // ========================================
            // INITIALIZE
            // ========================================
            console.log('üîë Reset password page loaded');
            console.log('üìç URL:', window.location.href);

            // Initialize icons when library is loaded
            waitForIcons(() => {
                initializeIcons();
                setupPasswordToggle('password', 'toggle-password');
                setupPasswordToggle('password-confirm', 'toggle-password-confirm');
            });

            // Start session initialization
            initializeSession();
        </script>
</body>

</html>